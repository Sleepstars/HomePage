---
import { ViewTransitions } from 'astro:transitions';
import '../styles/global.css';
import AnimatedBackground from '../components/AnimatedBackground.astro';
import ThemeToggle from '../components/ThemeToggle.astro';
import LanguagePicker from '../components/LanguagePicker.astro';
import { translations } from '../i18n/translations';
import { site } from '../data/site';
import { Image } from 'astro:assets';

interface Props {
  title: string;
  description?: string;
  lang?: string;
}

const { title, description = 'Web3 enthusiast, blockchain developer & indie hacker', lang = 'en' } = Astro.props;
// OpenGraph/Twitter helpers
const siteName = site.name;
const ogLocale = lang === 'zh' ? 'zh_CN' : 'en_US';
const currentUrl = typeof Astro !== 'undefined' && Astro.url ? Astro.url : undefined;
const canonical = currentUrl ? currentUrl.href : undefined;
const ogUrl = canonical;
const ogImage = currentUrl ? new URL('/avatar.webp', currentUrl).href : '/avatar.webp';
const translationsEncoded = encodeURIComponent(JSON.stringify(translations));
const nowYear = new Date().getFullYear();
const startYear = site.startYear ?? nowYear;
const yearText = startYear === nowYear ? `${nowYear}` : `${startYear}\u2013${nowYear}`;

// 公安备案：仅使用省份简称 + 数字编号
const psbNumber = site.psbNumber ?? '';
const psbProvince = site.psbProvince ?? '';
const psbHasInfo = Boolean(psbNumber);
const psbLink = psbHasInfo ? `https://www.beian.gov.cn/portal/registerSystemInfo?recordcode=${psbNumber}` : '';
const psbText = psbHasInfo ? `${psbProvince}公网安备 ${psbNumber} 号` : '';
---

<!DOCTYPE html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="keywords" content={lang === 'zh' ? 'AI, 人工智能, 开发者, 开源, 个人网站, 区块链, Web3, 独立开发者' : 'AI, artificial intelligence, developer, open source, personal website, blockchain, Web3, indie developer'} />
    <meta name="author" content="Sleepstars" />
    <meta name="robots" content="index, follow" />
    <title>{title}</title>
    {canonical && <link rel="canonical" href={canonical} />}
    
    <!-- hreflang tags for multilingual SEO -->
    <link rel="alternate" hreflang="en" href="https://sleepstars.net" />
    <link rel="alternate" hreflang="zh" href="https://sleepstars.net/zh" />
    <link rel="alternate" hreflang="x-default" href="https://sleepstars.net" />

    <!-- OpenGraph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    {ogUrl && <meta property="og:url" content={ogUrl} />}
    <meta property="og:site_name" content={siteName} />
    <meta property="og:locale" content={ogLocale} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:alt" content={title + ' - ' + description} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    
    <!-- Additional SEO tags -->
    <meta name="format-detection" content="telephone=no" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />

    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    <ViewTransitions />

    <!-- Apply theme immediately to prevent flash -->
    <script is:inline>
      // Apply theme before page renders
      (function() {
        const theme = (() => {
          if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
            return localStorage.getItem('theme');
          }
          if (typeof window !== 'undefined' && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            return 'dark';
          }
          return 'light';
        })();

        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      })();

      // Fix theme flash during View Transitions
      document.addEventListener('astro:before-swap', (ev) => {
        const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        if (currentTheme === 'dark') {
          ev.newDocument.documentElement.classList.add('dark');
        } else {
          ev.newDocument.documentElement.classList.remove('dark');
        }
      });
    </script>

    <!-- Favicon -->
    <link rel="icon" type="image/webp" href="/favicon.webp" />
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#3b82f6" />
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="/favicon.webp" />

    <!-- Fonts (async to avoid render-blocking) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="preload"
      as="style"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript>
      <link
        rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      />
    </noscript>

    <style>
      html {
        font-family: 'Inter', system-ui, sans-serif;
      }
    </style>
    <!-- Lean flag icons CSS (async, tiny) -->
    <link
      rel="preload"
      as="style"
      href="/flags/flags-lean.css"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript>
      <link rel="stylesheet" href="/flags/flags-lean.css" />
    </noscript>
  <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
      {{
        "@context": "https://schema.org",
        "@type": "Person",
        "name": "Sleepstars",
        "url": "https://sleepstars.net",
        "sameAs": [
          "https://github.com/Sleepstars",
          "https://twitter.com/Sleep_stars_",
          "https://mastodon.social/@Sleepstars",
          "https://t.me/Sleepstars"
        ],
        "jobTitle": lang === 'zh' ? "AI 爱好者，学生 & 独立开发者" : "AI enthusiast, student & indie developer",
        "description": description,
        "image": "https://sleepstars.net/avatar.webp",
        "email": "admin@sleepstars.net",
        "knowsAbout": [
          "Artificial Intelligence",
          "Web Development",
          "Blockchain",
          "Open Source"
        ],
        "nationality": {
          "@type": "Country",
          "name": "China"
        },
        "knowsLanguage": ["English", "Chinese"]
      }}
    </script>

    <!-- Website Schema -->
    <script type="application/ld+json">
      {{
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": siteName,
        "url": "https://sleepstars.net",
        "description": description,
        "inLanguage": lang === 'zh' ? "zh-CN" : "en-US",
        "isAccessibleForFree": true,
        "isPartOf": {
          "@type": "WebSite",
          "name": siteName,
          "url": "https://sleepstars.net"
        }
      }}
    </script>
  </head>
  <body class="bg-white dark:bg-black text-gray-900 dark:text-gray-100 min-h-screen" data-translations={translationsEncoded}>
    <script is:inline>
      (function () {
        if (typeof window === 'undefined') return;

        const STORAGE_KEY = 'preferred-language';
        const MANUAL_SWITCH_KEY = 'manual-language-switch';
        const SUPPORTED_LANGS = ['en', 'zh'];

        // Skip auto-redirect if user manually switched language
        const manualSwitch = sessionStorage.getItem(MANUAL_SWITCH_KEY);
        if (manualSwitch === 'true') {
          return;
        }

        const getBrowserLang = () => {
          const navigatorLangs = Array.isArray(navigator.languages) ? navigator.languages : [navigator.language];
          const normalized = navigatorLangs
            .filter(Boolean)
            .map((lang) => lang.toLowerCase());

          if (normalized.some((lang) => lang.startsWith('zh'))) {
            return 'zh';
          }

          return 'en';
        };

        const currentPath = window.location.pathname;
        const currentLang = currentPath.startsWith('/zh') ? 'zh' : 'en';
        const stripLocaleFromPath = (pathname) => pathname.replace(/^\/(zh)(?=\/|$)/, '') || '/';

        const storedLang = (() => {
          try {
            const value = window.localStorage.getItem(STORAGE_KEY);
            return SUPPORTED_LANGS.includes(value ?? '') ? value : null;
          } catch (error) {
            return null;
          }
        })();

        const targetLang = storedLang ?? getBrowserLang();

        if (targetLang === currentLang) {
          return;
        }

        const basePath = stripLocaleFromPath(currentPath);
        const search = window.location.search ?? '';
        const hash = window.location.hash ?? '';

        const targetPath = targetLang === 'zh'
          ? (basePath === '/' ? '/zh' : `/zh${basePath}`)
          : basePath;

        try {
          window.localStorage.setItem(STORAGE_KEY, targetLang);
        } catch (error) {
          // ignore write errors (e.g. private mode)
        }

        if (targetPath && targetPath !== currentPath) {
          window.location.replace(`${targetPath}${search}${hash}`);
        }
      })();
    </script>
    <AnimatedBackground />

    <!-- Header with frosted glass effect -->
    <header
      class="fixed inset-x-0 top-0 z-50 border-b border-white/40 dark:border-white/10 bg-white/80 dark:bg-zinc-900/70 backdrop-blur-xl shadow-[0_10px_40px_rgba(15,23,42,0.08)] transition-colors"
    >
      <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <!-- Logo/Avatar -->
          <a href={lang === 'zh' ? '/zh' : '/'} class="flex items-center gap-3 group">
            <Image
              src="/avatar.webp"
              alt="Sleepstars - AI enthusiast and indie developer"
              width={40}
              height={40}
              loading="eager"
              class="w-10 h-10 rounded-full border-2 border-white/30 dark:border-white/20 group-hover:border-blue-400 dark:group-hover:border-blue-400 transition-all duration-300 shadow-lg"
            />
            <span class="font-semibold text-lg hidden sm:inline bg-gradient-to-r from-gray-900 to-gray-700 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">Sleepstars</span>
          </a>

          <!-- Navigation Links -->
          <nav class="hidden md:flex items-center gap-6">
            <a 
              href={lang === 'zh' ? '/zh' : '/'}
              class="text-base font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
              data-i18n-key="nav.home"
            >
              {translations[lang]['nav.home']}
            </a>
            <a 
              href={lang === 'zh' ? '/zh/projects' : '/projects'}
              class="text-base font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
              data-i18n-key="nav.projects"
            >
              {translations[lang]['nav.projects']}
            </a>
          </nav>

          <!-- Controls -->
          <div class="flex items-center gap-2">
            <LanguagePicker />
            <ThemeToggle />
            <!-- Mobile menu button -->
            <button 
              id="mobile-menu-button" 
              class="md:hidden p-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors relative z-50"
              aria-label="Toggle navigation menu"
              type="button"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Mobile Navigation Menu -->
    <div id="mobile-menu" class="hidden fixed inset-x-0 top-16 z-40 md:hidden">
      <div class="bg-white/95 dark:bg-zinc-900/95 backdrop-blur-xl border-b border-white/40 dark:border-white/10 shadow-lg">
        <nav class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
          <div class="flex flex-col space-y-3">
            <a 
              href={lang === 'zh' ? '/zh' : '/'}
              class="block px-4 py-3 rounded-lg text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
              data-i18n-key="nav.home"
            >
              {translations[lang]['nav.home']}
            </a>
            <a 
              href={lang === 'zh' ? '/zh/projects' : '/projects'}
              class="block px-4 py-3 rounded-lg text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
              data-i18n-key="nav.projects"
            >
              {translations[lang]['nav.projects']}
            </a>
          </div>
        </nav>
      </div>
    </div>

    <!-- Main content - reduced top padding to allow content to scroll under header -->
    <main class="relative pt-20 pb-16">
      <slot />
    </main>

    <!-- Footer -->
    <footer class="relative border-t border-gray-200 dark:border-gray-800 py-8">
      <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center space-y-2">
          <p class="text-sm text-gray-600 dark:text-gray-400 flex flex-wrap items-center justify-center gap-x-3 gap-y-1">
            <span>© {yearText} {site.name}</span>
            {site.icp && (
              <a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener noreferrer" class="text-gray-600 dark:text-gray-400 hover:underline">
                {site.icp}
              </a>
            )}
            {psbHasInfo && (
              <a href={psbLink} target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 text-gray-600 dark:text-gray-400 hover:underline">
                <img src="/icons/ghs.webp" alt="公安备案" width="16" height="16" loading="lazy" decoding="async" fetchpriority="low" class="w-4 h-4 inline-block" />
                <span>{psbText}</span>
              </a>
            )}
          </p>
          <p class="text-center text-xs text-gray-500 dark:text-gray-500">
            Built with <a href="https://astro.build" target="_blank" rel="noopener noreferrer" class="text-blue-600 dark:text-blue-400 hover:underline">Astro</a> and <a href="https://tailwindcss.com" target="_blank" rel="noopener noreferrer" class="text-blue-600 dark:text-blue-400 hover:underline">Tailwind CSS</a>
          </p>
        </div>
      </div>
    </footer>

    <!-- Client-side language management -->
    <script is:inline>
      (function () {
        const TRANSLATIONS = (() => {
          try {
            const encoded = document.body?.dataset?.translations;
            return encoded ? JSON.parse(decodeURIComponent(encoded)) : {};
          } catch (error) {
            return {};
          }
        })();
        const STORAGE_KEY = 'preferred-language';
        const MANUAL_SWITCH_KEY = 'manual-language-switch';
        const FALLBACK_LANG = 'en';

        const getLangFromPath = (path) => (path.startsWith('/zh') ? 'zh' : 'en');

        const resolveTranslation = (lang, key) => {
          const dictionary = TRANSLATIONS[lang] || TRANSLATIONS[FALLBACK_LANG] || {};
          if (Object.prototype.hasOwnProperty.call(dictionary, key)) {
            return dictionary[key];
          }
          const fallbackDictionary = TRANSLATIONS[FALLBACK_LANG] || {};
          return fallbackDictionary[key] ?? '';
        };

        const updateDocumentMeta = (lang) => {
          const title = resolveTranslation(lang, 'site.title');
          const description = resolveTranslation(lang, 'site.description');

          if (title) {
            document.title = title;
          }

          if (description) {
            const meta = document.querySelector('meta[name="description"]');
            if (meta) {
              meta.setAttribute('content', description);
            }
          }
        };

        const updateDomTexts = (lang) => {
          const elements = document.querySelectorAll('[data-i18n-key]');

          elements.forEach((element) => {
            const key = element.getAttribute('data-i18n-key');
            if (!key) return;

            const mode = element.getAttribute('data-i18n-mode') || 'text';
            const value = resolveTranslation(lang, key);

            if (mode === 'html') {
              element.innerHTML = value;
            } else {
              element.textContent = value;
            }
          });
        };

        const applyLanguage = (lang, options = {}) => {
          const targetLang = TRANSLATIONS[lang] ? lang : FALLBACK_LANG;

          document.documentElement.setAttribute('lang', targetLang);
          updateDomTexts(targetLang);
          updateDocumentMeta(targetLang);

          if (!options.skipStorage) {
            try {
              localStorage.setItem(STORAGE_KEY, targetLang);
            } catch (error) {
              // ignore storage errors (e.g. private browsing)
            }
          }

          if (!options.skipSession) {
            try {
              sessionStorage.setItem(MANUAL_SWITCH_KEY, 'true');
            } catch (error) {
              // ignore session storage errors
            }
          }

          document.dispatchEvent(
            new CustomEvent('astro-language-applied', {
              detail: { lang: targetLang }
            })
          );

          return targetLang;
        };

        const setLanguage = (lang, options = {}) => applyLanguage(lang, options);

        window.__astroLang = {
          applyLanguage,
          setLanguage,
          getLangFromPath: (path) => getLangFromPath(path ?? window.location.pathname),
          resolveTranslation,
          translations: TRANSLATIONS
        };

        window.addEventListener('popstate', () => {
          const lang = getLangFromPath(window.location.pathname);
          applyLanguage(lang, { skipStorage: true, skipSession: true });
        });

        document.addEventListener('astro:page-load', () => {
          const lang = getLangFromPath(window.location.pathname);
          applyLanguage(lang, { skipStorage: true, skipSession: true });
        });

        applyLanguage(getLangFromPath(window.location.pathname), { skipStorage: true, skipSession: true });
      })();
    </script>

    <!-- Twemoji - Convert all emoji to Twitter-style SVG -->
    <script>
      document.addEventListener('astro:page-load', () => {
        // Load Twemoji from CDN
        const twemojiScript = document.createElement('script');
        twemojiScript.src = 'https://cdn.jsdelivr.net/npm/twemoji@latest/dist/twemoji.min.js';
        twemojiScript.crossOrigin = 'anonymous';
        twemojiScript.onload = function() {
          // Parse the entire document to replace emoji with Twemoji
          if (typeof twemoji !== 'undefined') {
            twemoji.parse(document.body, {
              folder: 'svg',
              ext: '.svg',
              base: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/',
              attributes: () => ({
                loading: 'lazy',
                decoding: 'async',
                fetchpriority: 'low',
                crossorigin: 'anonymous',
                draggable: 'false'
              })
            });
          }
        };

        // Only append if not already loaded
        if (!window.twemoji) {
          document.head.appendChild(twemojiScript);
        } else {
          twemoji.parse(document.body, {
            folder: 'svg',
            ext: '.svg',
            base: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/',
            attributes: () => ({
              loading: 'lazy',
              decoding: 'async',
              fetchpriority: 'low',
              crossorigin: 'anonymous',
              draggable: 'false'
            })
          });
        }
      });
    </script>

    <!-- Preserve scroll position for language switching -->
    <script>
      let savedScrollPosition = 0;

      document.addEventListener('astro:before-preparation', () => {
        // Save current scroll position
        savedScrollPosition = window.scrollY;
      });

      document.addEventListener('astro:after-swap', () => {
        // Restore scroll position after page swap
        window.scrollTo({
          top: savedScrollPosition,
          behavior: 'instant'
        });
      });
    </script>

    <!-- Mobile menu toggle functionality -->
    <script is:inline>
      (function() {
        let isMenuOpen = false;
        let clickOutsideHandler = null;
        let keydownHandler = null;
        let resizeHandler = null;

        function toggleMenu() {
          const mobileMenu = document.getElementById('mobile-menu');
          const menuButton = document.getElementById('mobile-menu-button');
          
          if (!mobileMenu || !menuButton) return;
          
          isMenuOpen = !isMenuOpen;
          
          if (isMenuOpen) {
            mobileMenu.classList.remove('hidden');
            menuButton.innerHTML = `
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            `;
          } else {
            mobileMenu.classList.add('hidden');
            menuButton.innerHTML = `
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            `;
          }
        }

        function closeMenu() {
          const mobileMenu = document.getElementById('mobile-menu');
          const menuButton = document.getElementById('mobile-menu-button');
          
          if (mobileMenu && menuButton && isMenuOpen) {
            isMenuOpen = false;
            mobileMenu.classList.add('hidden');
            menuButton.innerHTML = `
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            `;
          }
        }

        function initMobileMenu() {
          const menuButton = document.getElementById('mobile-menu-button');
          if (!menuButton) return;

          // Remove existing listeners by cloning and replacing the button
          const newMenuButton = menuButton.cloneNode(true);
          menuButton.parentNode?.replaceChild(newMenuButton, menuButton);

          // Add click listener to the new button
          newMenuButton.addEventListener('click', (event) => {
            event.stopPropagation();
            toggleMenu();
          });

          // Remove old document-level listeners
          if (clickOutsideHandler) {
            document.removeEventListener('click', clickOutsideHandler);
          }
          if (keydownHandler) {
            document.removeEventListener('keydown', keydownHandler);
          }
          if (resizeHandler) {
            window.removeEventListener('resize', resizeHandler);
          }

          // Close menu when clicking outside
          clickOutsideHandler = (event) => {
            const mobileMenu = document.getElementById('mobile-menu');
            const currentButton = document.getElementById('mobile-menu-button');
            
            if (currentButton && mobileMenu && 
                !currentButton.contains(event.target) && 
                !mobileMenu.contains(event.target)) {
              closeMenu();
            }
          };
          document.addEventListener('click', clickOutsideHandler);

          // Close menu on Escape key
          keydownHandler = (event) => {
            if (event.key === 'Escape') {
              closeMenu();
            }
          };
          document.addEventListener('keydown', keydownHandler);

          // Close menu on window resize to desktop
          resizeHandler = () => {
            if (window.innerWidth >= 768) {
              closeMenu();
            }
          };
          window.addEventListener('resize', resizeHandler);
        }

        // Initialize on page load
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initMobileMenu);
        } else {
          initMobileMenu();
        }

        // Reinitialize after Astro page navigation
        document.addEventListener('astro:page-load', initMobileMenu);
      })();
    </script>
  </body>
</html>
